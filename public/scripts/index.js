const ICE_config= {
    'iceServers': [
        {'url': 'stun:stun.l.google.com:19302'},
        {'url':'stun.root-1.de:3478'},
        {'url':'stun.signalwire.com:3478'},
        {'url':'stun.comrex.com:3478'},
        {'url':'stun.labs.net:3478'},
        {'url':'stun.streamnow.ch:3478'},
        {'url':'stun.nfon.net:3478'},
        {'url':'stun.megatel.si:3478'},
        {'url':'stun.junet.se:3478'},
        {'url':'stun.stadtwerke-eutin.de:3478'},
        {'url':'stun.ppdi.com:3478'},
        {'url':'stun.syncthing.net:3478'},
        {'url':'stun.bearstech.com:3478'},
        {'url':'stun.flashdance.cx:3478'},
        {'url':'stun.zadarma.com:3478'},
        {'url':'stun.voipbuster.com:3478'},
        {'url':'stun.studio-link.de:3478'},
        {'url':'stun.grazertrinkwasseringefahr.at:3478'},
        {'url':'stun.gigaset.net:3478'},
        {'url':'stun.siedle.com:3478'},
        {'url':'stun.myspeciality.com:3478'},
        {'url':'stun.medvc.eu:3478'},
        {'url':'stun.sipglobalphone.com:3478'},
        {'url':'stun.cablenet-as.net:3478'},
        {'url':'stun.voippro.com:3478'},
        {'url':'stun.sippeer.dk:3478'},
        {'url':'stun.jabber.dk:3478'},
        {'url':'stun.actionvoip.com:3478'},
        {'url':'stun.voip.blackberry.com:3478'},
        {'url':'stun.thebrassgroup.it:3478'},
        {'url':'stun.tng.de:3478'},
        {'url':'stun.tel.lu:3478'},
        {'url':'stun.l.google.com:19302'},
        {'url':'stun.dunyatelekom.com:3478'},
        {'url':'stun.bitburger.de:3478'},
        {'url':'stun.voipzoom.com:3478'},
        {'url':'stun.siptraffic.com:3478'},
        {'url':'stun.voipconnect.com:3478'},
        {'url':'stun.avigora.fr:3478'},
        {'url':'stun.internetcalls.com:3478'},
        {'url':'stun.deepfinesse.com:3478'},
        {'url':'stun.heeds.eu:3478'},
        {'url':'stun.usfamily.net:3478'},
        {'url':'stun.sonetel.com:3478'},
        {'url':'stun.vo.lu:3478'},
        {'url':'stun.mixvoip.com:3478'},
        {'url':'stun.nanocosmos.de:3478'},
        {'url':'stun.ringostat.com:3478'},
        {'url':'stun.bethesda.net:3478'},
        {'url':'stun.voipfibre.com:3478'},
        {'url':'stun.ru-brides.com:3478'},
        {'url':'stun.gntel.nl:3478'},
        {'url':'stun.localphone.com:3478'},
        {'url':'stun.qcol.net:3478'},
        {'url':'stun.marcelproust.it:3478'},
        {'url':'stun.vavadating.com:3478'},
        {'url':'stun.voip.eutelia.it:3478'},
        {'url':'stun.acquageraci.it:3478'},
        {'url':'stun.fbsbx.com:3478'},
        {'url':'stun.splicecom.com:3478'},
        {'url':'stun.bandyer.com:3478'},
        {'url':'stun.irishvoip.com:3478'},
        {'url':'stun.voip.aebc.com:3478'},
        {'url':'stun.freecall.com:3478'},
        {'url':'stun.geonet.ro:3478'},
        {'url':'stun.telbo.com:3478'},
        {'url':'stun.counterpath.com:3478'},
        {'url':'stun.allflac.com:3478'},
        {'url':'stun.nexxtmobile.de:3478'},
        {'url':'stun.waterpolopalermo.it:3478'},
        {'url':'stun.1-voip.com:3478'},
        {'url':'stun.leucotron.com.br:3478'},
        {'url':'stun.schulinformatik.at:3478'},
        {'url':'stun.levigo.de:3478'},
        {'url':'stun.goldfish.ie:3478'},
        {'url':'stun2.l.google.com:19302'},
        {'url':'stun.yesdates.com:3478'},
        {'url':'stun.vadacom.co.nz:3478'},
        {'url':'stun.meowsbox.com:3478'},
        {'url':'stun.3wayint.com:3478'},
        {'url':'stun.voipgrid.nl:3478'},
        {'url':'stun.poivy.com:3478'},
        {'url':'stun.smartvoip.com:3478'},
        {'url':'stun.var6.cn:3478'},
        {'url':'stun.solnet.ch:3478'},
        {'url':'stun.studio71.it:3478'},
        {'url':'stun.nexphone.ch:3478'},
        {'url':'stun.voipcheap.co.uk:3478'},
        {'url':'stun.fmo.de:3478'},
        {'url':'stun.geesthacht.de:3478'},
        {'url':'stun.rynga.com:3478'},
        {'url':'stun.diallog.com:3478'},
        {'url':'stun.lowratevoip.com:3478'},
        {'url':'stun.ipshka.com:3478'},
        {'url':'stun.technosens.fr:3478'},
        {'url':'stun.nonoh.net:3478'},
        {'url':'stun.voys.nl:3478'},
        {'url':'stun.webcalldirect.com:3478'},
        {'url':'stun.lebendigefluesse.at:3478'},
        {'url':'stun.netgsm.com.tr:3478'},
        {'url':'stun.peethultra.be:3478'},
        {'url':'stun.healthtap.com:3478'},
        {'url':'stun.plexicomm.net:3478'},
        {'url':'stun.voipstreet.com:3478'},
        {'url':'stun.framasoft.org:3478'},
        {'url':'stun.voipvoice.it:3478'},
        {'url':'stun.thinkrosystem.com:3478'},
        {'url':'stun.imafex.sk:3478'},
        {'url':'stun.mywatson.it:3478'},
        {'url':'stun.siptrunk.com:3478'},
        {'url':'stun.leonde.org:3478'},
        {'url':'stun.optdyn.com:3478'},
        {'url':'stun.business-isp.nl:3478'},
        {'url':'stun.myvoiptraffic.com:3478'},
        {'url':'stun.intervoip.com:3478'},
        {'url':'stun.ladridiricette.it:3478'},
        {'url':'stun.hide.me:3478'},
        {'url':'stun.jowisoftware.de:3478'},
        {'url':'stun.threema.ch:3478'},
        {'url':'stun.jabbim.cz:3478'},
        {'url':'stun.aa.net.uk:3478'},
        {'url':'stun.gmx.de:3478'},
        {'url':'stun.fitauto.ru:3478'},
        {'url':'stun.wemag.com:3478'},
        {'url':'stun.kotter.net:3478'},
        {'url':'stun.skydrone.aero:3478'},
        {'url':'stun.srce.hr:3478'},
        {'url':'stun.cibercloud.com.br:3478'},
        {'url':'stun.cope.es:3478'},
        {'url':'stun.lovense.com:3478'},
        {'url':'stun.baltmannsweiler.de:3478'},
        {'url':'stun.12voip.com:3478'},
        {'url':'stun.rockenstein.de:3478'},
        {'url':'stun.nextcloud.com:443'},
        {'url':'stun.totalcom.info:3478'},
        {'url':'stun.telnyx.com:3478'},
        {'url':'stun.freevoipdeal.com:3478'},
        {'url':'stun.axialys.net:3478'},
        {'url':'stun4.l.google.com:19302'},
        {'url':'stun.oncloud7.ch:3478'},
        {'url':'stun.gmx.net:3478'},
        {'url':'stun.sonetel.net:3478'},
        {'url':'stun.voicetech.se:3478'},
        {'url':'stun.siplogin.de:3478'},
        {'url':'stun.officinabit.com:3478'},
        {'url':'stun.peeters.com:3478'},
        {'url':'stun.linuxtrent.it:3478'},
        {'url':'stun.easyvoip.com:3478'},
        {'url':'stun.aaisp.co.uk:3478'},
        {'url':'stun.simlar.org:3478'},
        {'url':'stun.pure-ip.com:3478'},
        {'url':'stun.neomedia.it:3478'},
        {'url':'stun.url.net.au:3478'},
        {'url':'stun.mobile-italia.com:3478'},
        {'url':'stun.schoeffel.de:3478'},
        {'url':'stun.ippi.fr:3478'},
        {'url':'stun.radiojar.com:3478'},
        {'url':'stun.romaaeterna.nl:3478'},
        {'url':'stun.landvast.nl:3478'},
        {'url':'stun.olimontel.it:3478'},
        {'url':'stun.poetamatusel.org:3478'},
        {'url':'stun.infra.net:3478'},
        {'url':'stun.5sn.com:3478'},
        {'url':'stun.jumblo.com:3478'},
        {'url':'stun.justvoip.com:3478'},
        {'url':'stun.dus.net:3478'},
        {'url':'stun.easybell.de:3478'},
        {'url':'stun.galeriemagnet.at:3478'},
        {'url':'stun.1und1.de:3478'},
        {'url':'stun.sigmavoip.com:3478'},
        {'url':'stun.voicetrading.com:3478'},
        {'url':'stun.teamfon.de:3478'},
        {'url':'stun.eleusi.com:3478'},
        {'url':'stun.chatous.com:3478'},
        {'url':'stun.zentauron.de:3478'},
        {'url':'stun.uabrides.com:3478'},
        {'url':'stun.it1.hr:3478'},
        {'url':'stun.engineeredarts.co.uk:3478'},
        {'url':'stun.webmatrix.com.br:3478'},
        {'url':'stun.halonet.pl:3478'},
        {'url':'stun.teliax.com:3478'},
        {'url':'stun.ippi.com:3478'},
        {'url':'stun.voipraider.com:3478'},
        {'url':'stun.files.fm:3478'},
        {'url':'stun.fathomvoice.com:3478'},
        {'url':'stun.wcoil.com:3478'},
        {'url':'stun.voipbusterpro.com:3478'},
        {'url':'stun.elitetele.com:3478'},
        {'url':'stun.3deluxe.de:3478'},
        {'url':'stun.dcalling.de:3478'},
        {'url':'stun.avoxi.com:3478'},
        {'url':'stun.voipblast.com:3478'},
        {'url':'stun.counterpath.net:3478'},
        {'url':'stun.callromania.ro:3478'},
        {'url':'stun.sipthor.net:3478'},
        {'url':'stun.graftlab.com:3478'},
        {'url':'stun.tula.nu:3478'},
        {'url':'stun.bcs2005.net:3478'},
        {'url':'stun.m-online.net:3478'},
        {'url':'stun.fixup.net:3478'},
        {'url':'stun.shadrinsk.net:3478'},
        {'url':'stun.solomo.de:3478'},
        {'url':'stun.bernardoprovenzano.net:3478'},
        {'url':'stun.annatel.net:3478'},
        {'url':'stun.westtel.ky:3478'},
        {'url':'stun.uls.co.za:3478'},
        {'url':'relay.webwormhole.io:3478'},
        {'url':'stun.epygi.com:3478'},
        {'url':'stun.clickphone.ro:3478'},
        {'url':'stun.voipia.net:3478'},
        {'url':'stun.fairytel.at:3478'},
        {'url':'stun.freeswitch.org:3478'},
        {'url':'stun.openvoip.it:3478'},
        {'url':'stun.ortopediacoam.it:3478'},
        {'url':'stun.myhowto.org:3478'},
        {'url':'stun.tel2.co.uk:3478'},
        {'url':'stun.isp.net.au:3478'},
        {'url':'stun.kanojo.de:3478'},
        {'url':'stun.syrex.co.za:3478'},
        {'url':'stun.powervoip.com:3478'},
        {'url':'stun.liveo.fr:3478'},
        {'url':'stun.kaseya.com:3478'},
        {'url':'stun.babelforce.com:3478'},
        {'url':'stun.logic.ky:3478'},
        {'url':'stun.voipcheap.com:3478'},
        {'url':'stun.ixc.ua:3478'},
        {'url':'stun.schlund.de:3478'},
        {'url':'stun.meetwife.com:3478'},
        {'url':'stun.piratenbrandenburg.de:3478'},
        {'url':'stun1.l.google.com:19302'},
        {'url':'stun.sipdiscount.com:3478'},
        {'url':'stun.voipwise.com:3478'},
        {'url':'stun.sparvoip.de:3478'},
        {'url':'stun.lineaencasa.com:3478'},
        {'url':'stun.ozekiphone.com:3478'},
        {'url':'stun.voipdiscount.com:3478'},
        {'url':'stun.nextcloud.com:3478'},
        {'url':'stun.myvoipapp.com:3478'},
        {'url':'stun.atagverwarming.nl:3478'},
        {'url':'stun.komsa.de:3478'},
        {'url':'stun.t-online.de:3478'},
        {'url':'stun.foad.me.uk:3478'},
        {'url':'stun.sma.de:3478'},
        {'url':'stun.crimeastar.net:3478'},
        {'url':'stun.tichiamo.it:3478'},
        {'url':'stun.acronis.com:3478'},
        {'url':'stun.frozenmountain.com:3478'},
        {'url':'stun.soho66.co.uk:3478'},
        {'url':'stun.romancecompass.com:3478'},
        {'url':'stun.planetarium.com.br:3478'},
        {'url':'stun.rolmail.net:3478'},
        {'url':'stun.futurasp.es:3478'},
        {'url':'stun.alphacron.de:3478'},
        {'url':'stun.bridesbay.com:3478'},
        {'url':'stun.moonlight-stream.org:3478'},
        {'url':'stun.hoiio.com:3478'},
        {'url':'stun.voipplanet.nl:3478'},
        {'url':'stun.vivox.com:3478'},
        {'url':'stun.linphone.org:3478'},
        {'url':'stun.lleida.net:3478'},
        {'url':'stun3.l.google.com:19302'},
        {'url':'stun.godatenow.com:3478'},
        {'url':'stun.twt.it:3478'},
        {'url':'stun.muoversi.net:3478'},
        {'url':'stun.swrag.de:3478'},
        {'url':'stun.axeos.nl:3478'},
        {'url':'stun.sky.od.ua:3478'},
        {'url':'stun.yollacalls.com:3478'},
        {'url':'stun.voipstunt.com:3478'},
        {'url':'stun.synergiejobs.be:3478'},
        {'url':'stun.vomessen.de:3478'},
        {'url':'stun.eol.co.nz:3478'},
        {'url':'stun.wtfismyip.com:3478'},
        {'url':'stun.ctafauni.it:3478'},
        {'url':'stun.miwifi.com:3478'},
        {'url':'stun.ncic.com:3478'},
        {'url':'stun.smsdiscount.com:3478'},
        {'url':'stun.imp.ch:3478'},
        {'url':'stun.voipinfocenter.com:3478'},
        {'url':'stun.taxsee.com:3478'},
        {'url':'stun.acrobits.cz:3478'},
        {'url':'stun.voztele.com:3478'},
        {'url':'stun.voipgate.com:3478'},
        {'url':'stun.easter-eggs.com:3478'},
        {'url':'stun.antisip.com:3478'},
        {'url':'stun.vozelia.com:3478'},
        {'url':'stun.verbo.be:3478'},
        {'url':'stun.stochastix.de:3478'},
        {'url':'stun.cheapvoip.com:3478'},
        {'url':'stun.voipgain.com:3478'},
        {'url':'stun.autosystem.com:3478'},
        {'url':'stun.dls.net:3478'},
        {'url':'stun.eoni.com:3478'},
        {'url':'stun.ekiga.net:3478'},
        {'url':'stun.ttmath.org:3478'},
        {'url':'stun.xten.com:3478'},
        {'url':'stun.genymotion.com:3478'},
        {'url':'stun.talkho.com:3478'},
        {'url':'stun.solcon.nl:3478'},
        {'url':'stun.netappel.com:3478'},
        {'url':'stun.smslisto.com:3478'},
        {'url':'stun.voipxs.nl:3478'},
        {'url':'stun.wxnz.net:3478'},
        {'url':'stun.alpirsbacher.de:3478'},
        {'url':'stun.sip.us:3478'},
        {'url':'stun.ukh.de:3478'},
        {'url':'stun.ipfire.org:3478'},
        {'url':'stun.arkh-edu.ru:3478'},
        {'url':'stun.alberon.cz:3478'},
        {'url':'stun.carlovizzini.it:3478'},
        {'url':'stun.hot-chilli.net:3478'},
        {'url':'stun.sewan.fr:3478'},
        {'url':'stun.next-gen.ro:3478'},
        {
            'url': 'turn:192.158.29.39:3478?transport=udp',
            'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
            'username': '28224511:1379330808'
        },
        {
            'url': 'turn:192.158.29.39:3478?transport=tcp',
            'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
            'username': '28224511:1379330808'
        }
    ]
}
const peerConnection = new RTCPeerConnection(ICE_config);
const socket = io.connect("/");

const iceCandidates = []

const TIMEOUT = 500

peerConnection.ontrack = function ({ streams: [stream] }) {
    const remoteVideo = document.getElementById("remote-video");
    if (remoteVideo) {
        remoteVideo.srcObject = stream;
    }
};

const addIceCandidates = (iceCandidates) => {
    iceCandidates.forEach((candidate) => {
        peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(candidate)))
    })
}

const setInfoText = (text) => {
    const infoText = document.getElementById('info-text');
    infoText.innerHTML = text
}


async function getMedia() {
    let stream = null;

    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        const localVideo = document.getElementById("local-video");
        if (localVideo) {
            localVideo.srcObject = stream;
        }

        stream
            .getTracks()
            .forEach((track) => peerConnection.addTrack(track, stream));
    } catch(err) {
        alert(err);
    }
}

getMedia()

peerConnection.onicecandidate = function(event) {
    if (event.candidate) {
        iceCandidates.push(JSON.stringify(event.candidate))
    }
};

document.getElementById("send-key").addEventListener("click", () => {
    const chatKey = document.getElementById("key-input").value;
    socket.emit("get-offer-by-key", {chatKey});
});

socket.on("offer-by-key-answer", async (data) => {
    if(data.offer) {
        setInfoText('Enjoy secure conversation')
        await receiveOfferAndCreateAnswer({
            chatKey: data.chatKey,
            offer: data.offer,
            offerIceCandidates: data.offerIceCandidates,
        })
    } else {
        setInfoText('Wait for friend')
        await createOfferAndSend(data.chatKey)
    }
});
socket.on("sent-answer-to-initiator", async ({answer, answerIceCandidates}) => {
    setInfoText('Enjoy secure conversation')
    receiveAndApplyAnswer({answer, answerIceCandidates})
});

socket.on("reconnect", async () => {
    const chatKey = document.getElementById("key-input").value;
    socket.emit("get-offer-by-key", {chatKey});
});

socket.on("chat-with-chosen-key-exist", async () => {
    setInfoText('Chat with chosen chat key already exist. Please, try another chat key.')
});

const receiveOfferAndCreateAnswer = async({chatKey, offer, offerIceCandidates}) => {
    console.log('b; answer =', JSON.stringify({chatKey, offer}, undefined, 2))
    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    addIceCandidates(offerIceCandidates)
    await new Promise((resolve) => setTimeout(resolve, TIMEOUT));
    socket.emit("sent-answer-to-server", {
        chatKey, answer,
        answerIceCandidates: iceCandidates
    });
}

const createOfferAndSend = async(chatKey) => {
    console.log('a; chatKey =', chatKey)
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    await new Promise((resolve) => setTimeout(resolve, TIMEOUT));
    socket.emit("sent-offer-to-server", {chatKey, offer, offerIceCandidates: iceCandidates});
}

const receiveAndApplyAnswer = async({answer, answerIceCandidates}) => {
    console.log('c; answer =', JSON.stringify(answer, undefined, 2))
    const remoteDesc = new RTCSessionDescription(answer);
    await peerConnection.setRemoteDescription(remoteDesc);
    addIceCandidates(answerIceCandidates)
}



